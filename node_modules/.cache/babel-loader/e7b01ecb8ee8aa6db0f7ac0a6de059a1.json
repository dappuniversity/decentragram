{"ast":null,"code":"var onfield = function onfield(f, result) {\n  var prefix = f.repeated ? 'repeated' : f.required ? 'required' : 'optional';\n  if (f.type === 'map') prefix = 'map<' + f.map.from + ',' + f.map.to + '>';\n  if (f.oneof) prefix = '';\n  var opts = Object.keys(f.options || {}).map(function (key) {\n    return key + ' = ' + f.options[key];\n  }).join(',');\n  if (opts) opts = ' [' + opts + ']';\n  result.push((prefix ? prefix + ' ' : '') + (f.map === 'map' ? '' : f.type + ' ') + f.name + ' = ' + f.tag + opts + ';');\n  return result;\n};\n\nvar onmessage = function onmessage(m, result) {\n  result.push('message ' + m.name + ' {');\n  if (!m.options) m.options = {};\n  onoption(m.options, result);\n  if (!m.enums) m.enums = [];\n  m.enums.forEach(function (e) {\n    result.push(onenum(e, []));\n  });\n  if (!m.messages) m.messages = [];\n  m.messages.forEach(function (m) {\n    result.push(onmessage(m, []));\n  });\n  var oneofs = {};\n  if (!m.fields) m.fields = [];\n  m.fields.forEach(function (f) {\n    if (f.oneof) {\n      if (!oneofs[f.oneof]) oneofs[f.oneof] = [];\n      oneofs[f.oneof].push(onfield(f, []));\n    } else {\n      result.push(onfield(f, []));\n    }\n  });\n  Object.keys(oneofs).forEach(function (n) {\n    oneofs[n].unshift('oneof ' + n + ' {');\n    oneofs[n].push('}');\n    result.push(oneofs[n]);\n  });\n  result.push('}', '');\n  return result;\n};\n\nvar onenum = function onenum(e, result) {\n  result.push('enum ' + e.name + ' {');\n  if (!e.options) e.options = {};\n  var options = onoption(e.options, []);\n\n  if (options.length > 1) {\n    result.push(options.slice(0, -1));\n  }\n\n  Object.keys(e.values).map(function (v) {\n    var val = onenumvalue(e.values[v]);\n    result.push([v + ' = ' + val + ';']);\n  });\n  result.push('}', '');\n  return result;\n};\n\nvar onenumvalue = function onenumvalue(v, result) {\n  var opts = Object.keys(v.options || {}).map(function (key) {\n    return key + ' = ' + v.options[key];\n  }).join(',');\n  if (opts) opts = ' [' + opts + ']';\n  var val = v.value + opts;\n  return val;\n};\n\nvar onoption = function onoption(o, result) {\n  var keys = Object.keys(o);\n  keys.forEach(function (option) {\n    var v = o[option];\n    if (~option.indexOf('.')) option = '(' + option + ')';\n    var type = typeof v;\n\n    if (type === 'object') {\n      v = onoptionMap(v, []);\n      if (v.length) result.push('option ' + option + ' = {', v, '};');\n    } else {\n      if (type === 'string' && option !== 'optimize_for') v = '\"' + v + '\"';\n      result.push('option ' + option + ' = ' + v + ';');\n    }\n  });\n\n  if (keys.length > 0) {\n    result.push('');\n  }\n\n  return result;\n};\n\nvar onoptionMap = function onoptionMap(o, result) {\n  var keys = Object.keys(o);\n  keys.forEach(function (k) {\n    var v = o[k];\n    var type = typeof v;\n\n    if (type === 'object') {\n      if (Array.isArray(v)) {\n        v.forEach(function (v) {\n          v = onoptionMap(v, []);\n          if (v.length) result.push(k + ' {', v, '}');\n        });\n      } else {\n        v = onoptionMap(v, []);\n        if (v.length) result.push(k + ' {', v, '}');\n      }\n    } else {\n      if (type === 'string') v = '\"' + v + '\"';\n      result.push(k + ': ' + v);\n    }\n  });\n  return result;\n};\n\nvar onservices = function onservices(s, result) {\n  result.push('service ' + s.name + ' {');\n  if (!s.options) s.options = {};\n  onoption(s.options, result);\n  if (!s.methods) s.methods = [];\n  s.methods.forEach(function (m) {\n    result.push(onrpc(m, []));\n  });\n  result.push('}', '');\n  return result;\n};\n\nvar onrpc = function onrpc(rpc, result) {\n  var def = 'rpc ' + rpc.name + '(';\n  if (rpc.client_streaming) def += 'stream ';\n  def += rpc.input_type + ') returns (';\n  if (rpc.server_streaming) def += 'stream ';\n  def += rpc.output_type + ')';\n  if (!rpc.options) rpc.options = {};\n  var options = onoption(rpc.options, []);\n\n  if (options.length > 1) {\n    result.push(def + ' {', options.slice(0, -1), '}');\n  } else {\n    result.push(def + ';');\n  }\n\n  return result;\n};\n\nvar indent = function indent(lvl) {\n  return function (line) {\n    if (Array.isArray(line)) return line.map(indent(lvl + '  ')).join('\\n');\n    return lvl + line;\n  };\n};\n\nmodule.exports = function (schema) {\n  var result = [];\n  result.push('syntax = \"proto' + schema.syntax + '\";', '');\n  if (schema.package) result.push('package ' + schema.package + ';', '');\n  if (!schema.options) schema.options = {};\n  onoption(schema.options, result);\n  if (!schema.enums) schema.enums = [];\n  schema.enums.forEach(function (e) {\n    onenum(e, result);\n  });\n  if (!schema.messages) schema.messages = [];\n  schema.messages.forEach(function (m) {\n    onmessage(m, result);\n  });\n\n  if (schema.services) {\n    schema.services.forEach(function (s) {\n      onservices(s, result);\n    });\n  }\n\n  return result.map(indent('')).join('\\n');\n};","map":null,"metadata":{},"sourceType":"script"}