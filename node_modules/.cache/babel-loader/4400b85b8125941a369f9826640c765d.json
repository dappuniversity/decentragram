{"ast":null,"code":"'use strict';\n\nvar createHmac = require('create-hmac');\n\nvar hashInfo = require('./lib/hash-info.json');\n\nvar ebuf = new Buffer(0);\nvar b0x00 = new Buffer([0x00]);\nvar b0x01 = new Buffer([0x01]);\n\nfunction HmacDRBG(algo, entropy, nonce, pers) {\n  var info = hashInfo[algo];\n  if (info === undefined) throw new Error('hash ' + algo + ' is not supported');\n  this._algo = algo;\n  this._securityStrength = info.securityStrength / 8;\n  this._outlen = info.outlen / 8;\n  this._reseedInterval = 0x1000000000000; // 2**48\n\n  this._init(entropy, nonce, pers);\n}\n\nHmacDRBG.prototype._update = function (seed) {\n  var kmac = createHmac(this._algo, this._K).update(this._V).update(b0x00);\n  if (seed) kmac.update(seed);\n  this._K = kmac.digest();\n  this._V = createHmac(this._algo, this._K).update(this._V).digest();\n  if (!seed) return;\n  this._K = createHmac(this._algo, this._K).update(this._V).update(b0x01).update(seed).digest();\n  this._V = createHmac(this._algo, this._K).update(this._V).digest();\n};\n\nHmacDRBG.prototype._init = function (entropy, nonce, pers) {\n  if (entropy.length < this._securityStrength) throw new Error('Not enough entropy');\n  this._K = new Buffer(this._outlen);\n  this._V = new Buffer(this._outlen);\n\n  for (var i = 0; i < this._K.length; ++i) {\n    this._K[i] = 0x00;\n    this._V[i] = 0x01;\n  }\n\n  this._update(Buffer.concat([entropy, nonce, pers || ebuf]));\n\n  this._reseed = 1;\n};\n\nHmacDRBG.prototype.reseed = function (entropy, add) {\n  if (entropy.length < this._securityStrength) throw new Error('Not enough entropy');\n\n  this._update(Buffer.concat([entropy, add || ebuf]));\n\n  this._reseed = 1;\n};\n\nHmacDRBG.prototype.generate = function (len, add) {\n  if (this._reseed > this._reseedInterval) throw new Error('Reseed is required');\n  if (add && add.length === 0) add = undefined;\n  if (add) this._update(add);\n  var temp = new Buffer(0);\n\n  while (temp.length < len) {\n    this._V = createHmac(this._algo, this._K).update(this._V).digest();\n    temp = Buffer.concat([temp, this._V]);\n  }\n\n  this._update(add);\n\n  this._reseed += 1;\n  return temp.slice(0, len);\n};\n\nmodule.exports = HmacDRBG;","map":null,"metadata":{},"sourceType":"script"}